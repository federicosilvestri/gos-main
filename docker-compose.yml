version: '3'
services:
  # -------------------------------------------- #
  # -------------------------------------------- #
  # Starting with API Gateway and Load Balancer  #
  # -------------------------------------------- #
  # -------------------------------------------- #

  nginx_lb_orchestrator:
    #
    # Nginx Orchestrator instance
    #
    container_name: load_balancer_orchestrator
    restart: always
    build: ./gos-api_gateway/nginx-orchestrator
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock # WARNING: with Winzozz it does not work, but we need it!
    - nginx_conf:/etc/nginx/conf.d

  nginx_lb:
    #
    # Nginx single instance
    #
    container_name: load_balancer
    restart: always
    build: ./gos-api_gateway/nginx
    labels:
      - gooutsafe.nginx_lb
    volumes:
    - nginx_conf:/etc/nginx/conf.d
    - static_contents:/static
    ports:
      - "80:80"

  api_gateway:
    #
    # API Gateway
    #
    # ! ! ! WARNING ! ! !
    # DO NOT set the container_name attribute and ports mapping
    # to allow the replication.
    #
    restart: always
    build: ./gos-api_gateway
    volumes:
      - static_contents:/static
    env_file:
      - gateway.conf
    environment:
      - USERS_MS_HOST=users_ms_worker_node
      # - RESTAURANTS_MS_HOST=restaurants_ms_worker_node
      # - RESERVATION_SMS_HOST=reservations_ms_worker_node
    labels:
      - gooutsafe.api_gateway_worker

  message_broker_rabmq:
    #
    # Message Broker Rabbit MQ
    #
    image: library/rabbitmq:3.6-management
    ports:
      - "15672:15672" # Management URL (only for utility)
    env_file:
      - mb_rabmq.conf

  users_ms_db:
    #
    # Users Microservice Database
    #
    image: library/postgres:10
    restart: on-failure
    env_file:
      - users_ms.conf

  users_ms_migrations:
    #
    # Users Microservice Migrations
    #
    build: ./gos-users
    env_file:
      - users_ms.conf
    environment:
      - POSTGRES_HOST=users_ms_db
      - RABBIT_MQ_HOST=message_broker_rabmq
    restart: on-failure
    command: flask db upgrade
    depends_on:
      - users_ms_db

  users_ms_worker_node:
    #
    # Users Microservices Worker node
    #
    build: ./gos-users
    restart: on-failure
    env_file:
      - users_ms.conf
    environment:
      - POSTGRES_HOST=users_ms_db
      - RABBIT_MQ_HOST=message_broker_rabmq
    depends_on:
      - users_ms_db
      - users_ms_migrations

volumes:
  #
  # Volumes declaration
  #

  nginx_conf:
    # Nginx configuration volume

  static_contents:
    # API Gateway static content volume